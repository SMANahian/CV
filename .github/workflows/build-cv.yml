name: Build and Publish CV PDFs

on:
  push:
    paths:
      - 'CV-long.tex'
      - 'CV-short.tex'
      - '.github/workflows/build-cv.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install TeX Live
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-extra texlive-fonts-recommended texlive-latex-recommended texlive-science texlive-fonts-extra ghostscript

      - name: Compile CV PDFs
        run: |
          set -e
          pdflatex -interaction=nonstopmode CV-long.tex || true
          pdflatex -interaction=nonstopmode CV-long.tex || true
          pdflatex -interaction=nonstopmode CV-short.tex || true
          pdflatex -interaction=nonstopmode CV-short.tex || true
          mkdir -p docs
          mv CV-long.pdf docs/CV-long.pdf
          mv CV-short.pdf docs/CV-short.pdf

      - name: Optimize PDFs (compress)
        run: |
          for f in docs/*.pdf; do
            gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.5 -dPDFSETTINGS=/printer -dNOPAUSE -dQUIET -dBATCH -sOutputFile="${f%.pdf}-min.pdf" "$f" || true
            if [ -f "${f%.pdf}-min.pdf" ]; then mv "${f%.pdf}-min.pdf" "$f"; fi
          done

      - name: Commit updated PDFs to docs
        run: |
          if [ -n "$(git status --porcelain docs)" ]; then
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add docs/CV-long.pdf docs/CV-short.pdf
            git commit -m "Automated build: update CV PDFs"
            git push
          fi

      - name: Upload artifacts (for manual download)
        uses: actions/upload-artifact@v4
        with:
          name: cv-pdfs
          path: docs/*.pdf
